minimum_pre_commit_version: "3.6.0"

default_language_version:
  python: python3.11

# Evita di analizzare cartelle generate/venv
exclude: |
  (?x)^(
    \.venv/|
    venv/|
    node_modules/|
    output/|
    dist/|
    build/|
    \.gitbook/|
    docs/_build/
  )

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: check-yaml
        stages: [pre-commit]
      - id: end-of-file-fixer
        stages: [pre-commit]
      - id: trailing-whitespace
        stages: [pre-commit]
      - id: mixed-line-ending
        args: ["--fix=lf"]
        stages: [pre-commit]
      - id: fix-byte-order-marker
        stages: [pre-commit]
      - id: check-merge-conflict
        stages: [pre-commit]
      - id: check-case-conflict
        stages: [pre-commit]
      - id: check-added-large-files
        args: ["--maxkb=1024"]
        stages: [pre-commit]
      - id: forbid-new-submodules
        stages: [pre-commit]

  # 1) isort prima di black (anche su pre-push, write-mode)
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: ["--profile=black", "--line-length=120"]
        types_or: [python]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  # 2) black in write-mode (anche su pre-push)
  - repo: https://github.com/psf/black
    rev: 24.8.0
    hooks:
      - id: black
        types_or: [python]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  # 3) ruff come lint/fix “leggero”
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.6.8
    hooks:
      - id: ruff
        args: ["--fix"]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  - repo: local
    hooks:
      - id: mypy
        name: mypy
        entry: mypy
        language: python
        additional_dependencies: ["mypy", "types-PyYAML"]
        files: ^src/(config_ui/|pipeline/drive/)|^src/pipeline/drive_utils\.py$
        pass_filenames: false
        args: ["--config-file", "mypy.ini"]
        stages: [pre-push]

      - id: forbid-unsafe-file-reads
        name: Forbid unsafe file reads (open/read_text/read_bytes) outside path_utils/tests/scripts
        entry: python scripts/dev/check_no_unsafe_reads.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: no-dup-ingest-csv
        name: forbid local emit/copy helpers (use semantic.api)
        entry: python scripts/dev/check_no_local_emit_or_copy.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: qa-safe
        name: qa-safe (isort/black/ruff/mypy se presenti)
        entry: python scripts/dev/qa_safe.py
        language: python
        additional_dependencies: [
            "PyMuPDF==1.24.14",
            "PyPDF2==3.0.1",
            "pydantic==2.7.1",
            "pydantic-settings==2.0.0",
            "python-dotenv==1.0.1",
            "python-slugify==8.0.4",
            "PyYAML==6.0.1",
            "requests==2.32.2",
            "google-api-python-client==2.127.0",
            "google-auth-httplib2==0.2.0",
            "google-auth-oauthlib==1.2.0",
            "spacy==3.7.4",
            "docker==7.0.0",
            "fpdf==1.7.2",
            "PyGithub==2.3.0",
            "reportlab==4.1.0",
            "typing-extensions==4.12.2",
            "annotated-types==0.7.0",
            "streamlit==1.50.0",
            "openai==1.109.1",
            "httpx==0.27.2",
            "tiktoken==0.7.0",
            "numpy==1.26.4",
            "google-auth==2.34.0",
            "httplib2==0.22.0",
            "requests-oauthlib==2.0.0",
            "sentence-transformers==2.7.0",
            "scikit-learn==1.5.1",
            "yake==0.4.8",
            "torch==2.8.0",
            "black==24.8.0",
            "isort==5.13.2",
            "ruff==0.6.4",
            "mypy==1.11.2",
            "pytest==8.3.2",
            "pytest-cov==5.0.0",
            "hypothesis==6.112.2",
            "types-PyYAML==6.0.12.20240808",
            "types-requests==2.32.4.20250809",
            "pre-commit==4.3.0",
            "pre-commit-hooks==4.6.0",
            "pip-audit==2.7.2",
        ]
        pass_filenames: false
        stages: [pre-push]

      # FIXER: rimuove C0/C1 e normalizza NFC (se modifica, pre-commit fallirà chiedendo di rieseguire il commit)
      - id: fix-control-chars
        name: Fix Unicode control chars (remove C0/C1 + NFC)
        entry: python scripts/forbid_control_chars.py --fix
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml))$"
        stages: [pre-commit]

      # GUARDIANO: blocca se restano caratteri di controllo o file non-UTF-8
      - id: forbid-control-chars
        name: Forbid Unicode control chars & non-UTF-8
        entry: python scripts/forbid_control_chars.py
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml))$"
        stages: [pre-commit]

      - id: forbid-streamlit-deprecated
        name: Forbid deprecated Streamlit APIs
        entry: python scripts/dev/check_streamlit_deprecations.py
        language: system
        pass_filenames: false
        stages: [pre-commit, pre-push]
      - id: ui-beta0-compliance
        name: UI beta0 compliance checks
        entry: python scripts/dev/check_ui_beta0_compliance.py
        language: system
        pass_filenames: false
        stages: [pre-commit, pre-push]

  - repo: https://github.com/zricethezav/gitleaks
    rev: v8.18.1
    hooks:
      - id: gitleaks
        args: [detect, --no-banner, --redact, --config, .gitleaks.toml]
        pass_filenames: false
        stages: [pre-commit]

  - repo: local
    hooks:
      - id: cspell
        name: cspell (docs + README)
        entry: npx --yes -p @cspell/dict-it-it cspell lint --no-progress --config cspell.json
        language: system
        pass_filenames: true
        files: ^(README\.md|docs/.*\.md)$
        stages: [pre-commit]
