minimum_pre_commit_version: "3.6.0"

default_language_version:
  python: python3.11

# Default: se un hook non dichiara "stages", resta su pre-commit.
# (Non cambia nulla per quelli che hanno giÃ  stages espliciti.)
default_stages: [pre-commit]

# Evita di analizzare cartelle generate/venv
exclude: |
  (?x)^(
    \.venv/|
    venv/|
    node_modules/|
    output/|
    dist/|
    build/|
    \.gitbook/|
    docs/_build/
  )

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-yaml
        stages: [pre-commit]
      - id: end-of-file-fixer
        stages: [pre-commit]
      - id: trailing-whitespace
        stages: [pre-commit]
      - id: mixed-line-ending
        args: ["--fix=lf"]
        exclude: \.(ps1|cmd|bat)$
        stages: [pre-commit]
      - id: fix-byte-order-marker
        stages: [pre-commit]
      - id: check-merge-conflict
        stages: [pre-commit]
      - id: check-case-conflict
        stages: [pre-commit]
      - id: check-added-large-files
        args: ["--maxkb=1024"]
        stages: [pre-commit]
      - id: forbid-new-submodules
        stages: [pre-commit]

  # 1) isort prima di black (anche su pre-push, write-mode)
  - repo: https://github.com/pycqa/isort
    rev: 7.0.0
    hooks:
      - id: isort
        args: ["--profile=black", "--line-length=120"]
        types_or: [python]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  # 2) black in write-mode (anche su pre-push)
  - repo: https://github.com/psf/black
    rev: 26.1.0
    hooks:
      - id: black
        types_or: [python]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  # 3) ruff come lint/fix "leggero"
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.15.1
    hooks:
      - id: ruff
        args: ["--fix"]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  - repo: local
    hooks:
      - id: cspell
        name: cspell (docs + README + src + tests)
        entry: cspell lint --no-progress --config cspell.json
        language: node
        additional_dependencies: ["cspell@9.2.1", "@cspell/dict-it-it@3.1.6"]
        pass_filenames: true
        files: ^(README\.md|docs/.*\.md|src/.*\.py|tests/.*\.py)$
        stages: [pre-commit]

      - id: mypy
        name: mypy
        entry: mypy
        language: python
        additional_dependencies: ["mypy", "types-PyYAML", "types-requests==2.32.4.20250809"]
        files: ^src/(config_ui/|pipeline/drive/)|^src/pipeline/drive_utils\.py$
        pass_filenames: false
        args: ["--config-file", "mypy.ini", "src/pipeline/drive", "src/pipeline/drive_utils.py"]
        stages: [pre-push]

      - id: forbid-unsafe-file-reads
        name: Forbid unsafe file reads (open/read_text/read_bytes) outside path_utils/tests/scripts
        entry: python tools/smoke/check_no_unsafe_reads.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: no-dup-ingest-csv
        name: forbid local emit/copy helpers (use semantic.api)
        entry: python tools/smoke/check_no_local_emit_or_copy.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: template-hardline
        name: Template hardline guard (templates/mapping)
        entry: python tools/smoke/check_template_hardline.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: forbid-runtime-asserts
        name: Forbid runtime asserts in src/
        entry: python tools/dev/forbid_runtime_asserts.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        stages: [pre-commit]

      - id: forbid-path-write-text-bytes
        name: Forbid Path.write_text/bytes in src/ (use safe_write_*)
        entry: python tools/dev/forbid_path_writetext_bytes.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        stages: [pre-commit]

      - id: qa-safe
        name: qa-safe (isort/black/ruff/mypy se presenti)
        entry: python tools/dev/qa_safe.py
        language: python
        additional_dependencies:
          [
            "PyMuPDF==1.24.14",
            "PyPDF2==3.0.1",
            "pypdf==6.4.0",
            "pydantic==2.7.1",
            "pydantic-settings==2.0.0",
            "python-dotenv==1.0.1",
            "python-slugify==8.0.4",
            "PyYAML==6.0.1",
            "requests==2.32.2",
            "google-api-python-client==2.127.0",
            "google-auth-httplib2==0.2.0",
            "google-auth-oauthlib==1.2.0",
            "spacy==3.7.4",
            "docker==7.0.0",
            "fpdf==1.7.2",
            "PyGithub==2.3.0",
            "reportlab==4.1.0",
            "typing-extensions==4.12.2",
            "annotated-types==0.7.0",
            "streamlit==1.50.0",
            "openai==2.3.0",
            "httpx==0.27.2",
            "tiktoken==0.7.0",
            "numpy==1.26.4",
            "google-auth==2.34.0",
            "httplib2==0.22.0",
            "requests-oauthlib==2.0.0",
            "sentence-transformers==2.7.0",
            "scikit-learn==1.5.1",
            "yake==0.4.8",
            "torch==2.8.0",
            "black==26.1.0",
            "isort==7.0.0",
            "ruff==0.15.1",
            "mypy==1.11.2",
            "hypothesis==6.112.2",
            "types-PyYAML==6.0.12.20240808",
            "types-requests==2.32.4.20250809",
            "pre-commit==4.3.0",
            "pre-commit-hooks==6.0.0",
            "pip-audit==2.7.2",
          ]
        pass_filenames: false
        stages: [pre-push]

      - id: no-secrets-in-yaml
        name: Forbid inline secrets in config YAML
        entry: python tools/smoke/check_yaml_secrets.py
        language: system
        pass_filenames: true
        files: ^config/.*\.ya?ml$
        stages: [pre-commit, pre-push]

      # FIXER: rimuove C0/C1 e normalizza NFC (se modifica, pre-commit fallirÃ  chiedendo di rieseguire il commit)
      - id: fix-control-chars
        name: Fix Unicode control chars (remove C0/C1 + NFC)
        entry: python tools/forbid_control_chars.py --fix
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml))$"
        stages: [pre-commit]

      # GUARDIANO: blocca se restano caratteri di controllo o file non-UTF-8
      - id: forbid-control-chars
        name: Forbid Unicode control chars & non-UTF-8
        entry: python tools/forbid_control_chars.py
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml))$"
        stages: [pre-commit]

      # GUARDIANO: blocca smart quotes/dashes (curly quotes, en/em dash).
      # Richiede che tools/replace_quotes.py supporti --check.
      - id: forbid-smart-quotes
        name: Forbid smart quotes/dashes (unicode punctuation)
        entry: python tools/replace_quotes.py --check
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml|py))$"
        stages: [pre-commit]

      # FIXER: eseguilo quando serve (manuale), non in automatico.
      - id: fix-smart-quotes
        name: Fix smart quotes/dashes (manual)
        entry: python tools/replace_quotes.py
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml|py))$"
        stages: [manual]

      - id: forbid-streamlit-deprecated
        name: Forbid deprecated Streamlit APIs
        entry: python tools/smoke/check_streamlit_deprecations.py
        language: system
        pass_filenames: false
        stages: [pre-commit, pre-push]

      - id: streamlit-ui-guard
        name: Streamlit UI guard (router + path-safety + logging)
        entry: python tools/smoke/check_streamlit_ui.py --ci
        language: system
        pass_filenames: false
        stages: [pre-commit, pre-push]

      - id: ui-strict-runtime-guard
        name: UI strict runtime guard (dotenv/schema bypass)
        entry: python tools/ai_checks/ui_strict_runtime_guard.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: forbid-hardcoded-vision-model
        name: Forbid hardcoded Vision model in UI services
        entry: python tools/smoke/check_no_hardcoded_vision_model.py
        language: system
        files: ^src/ui/services/.*\.py$
        pass_filenames: true
        stages: [pre-commit, pre-push]

      # ðŸ”’ Nuovo: vieta ValueError ai boundary runtime (cross-platform)
      - id: forbid-legacy-valueerror
        name: Forbid ValueError in runtime layers
        language: pygrep
        entry: 'raise\s*ValueError\('
        files: ^src/(ui|pipeline|semantic)/.*\.py$
        stages: [pre-commit, pre-push]

      - id: add-spdx-headers
        name: Auto add missing SPDX headers
        entry: python tools/dev/add_spdx_headers.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: check-spdx-headers
        name: Check SPDX headers in Python files
        entry: python tools/smoke/check_spdx_headers.py
        language: system
        pass_filenames: true
        types_or: [python]
        files: ^(src|tests|scripts)/.*\.py$
        stages: [pre-commit]

  - repo: https://github.com/zricethezav/gitleaks
    rev: v8.30.0
    hooks:
      - id: gitleaks
        args: [detect, --no-banner, --redact, --config, .gitleaks.toml]
        pass_filenames: false
        stages: [pre-commit]

  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args: ["--baseline", ".secrets.baseline"]
        # Exclude deterministic SHA256 fixture; not a secret.
        exclude: "^(src/ui/pages/secrets_guide\\.yaml|tests/fixtures/determinism_manifest\\.json)$"
        stages: [pre-commit]
