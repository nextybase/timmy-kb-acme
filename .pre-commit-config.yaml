minimum_pre_commit_version: "3.6.0"

default_language_version:
  python: python3.11

# Evita di analizzare cartelle generate/venv
exclude: |
  (?x)^(
    \.venv/|
    venv/|
    node_modules/|
    output/|
    dist/|
    build/|
    \.gitbook/|
    docs/_build/
  )

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: check-yaml
        stages: [pre-commit]
      - id: end-of-file-fixer
        stages: [pre-commit]
      - id: trailing-whitespace
        stages: [pre-commit]
      - id: mixed-line-ending
        args: ["--fix=lf"]
        stages: [pre-commit]
      - id: fix-byte-order-marker
        stages: [pre-commit]
      - id: check-merge-conflict
        stages: [pre-commit]
      - id: check-case-conflict
        stages: [pre-commit]
      - id: check-added-large-files
        args: ["--maxkb=1024"]
        stages: [pre-commit]
      - id: forbid-new-submodules
        stages: [pre-commit]

  # 1) isort prima di black (anche su pre-push, write-mode)
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: ["--profile=black", "--line-length=120"]
        types_or: [python]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  # 2) black in write-mode (anche su pre-push)
  - repo: https://github.com/psf/black
    rev: 24.8.0
    hooks:
      - id: black
        types_or: [python]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  # 3) ruff come lint/fix “leggero”
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.6.8
    hooks:
      - id: ruff
        args: ["--fix"]
        files: ^(src|tests)/
        stages: [pre-commit, pre-push]

  - repo: local
    hooks:
      - id: mypy
        name: mypy
        entry: mypy
        language: python
        additional_dependencies: ["mypy", "types-PyYAML"]
        files: ^src/(config_ui/|pipeline/drive/)|^src/pipeline/drive_utils\.py$
        pass_filenames: false
        args: ["--config-file", "mypy.ini"]
        stages: [pre-push]

      - id: forbid-unsafe-file-reads
        name: Forbid unsafe file reads (open/read_text/read_bytes) outside path_utils/tests/scripts
        entry: python scripts/dev/check_no_unsafe_reads.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: no-dup-ingest-csv
        name: forbid local emit/copy helpers (use semantic.api)
        entry: python scripts/dev/check_no_local_emit_or_copy.py
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: qa-safe
        name: qa-safe (isort/black/ruff/mypy se presenti)
        entry: python scripts/dev/qa_safe.py
        language: python
        additional_dependencies: ["black==24.8.0", "isort==5.13.2", "ruff", "mypy", "types-PyYAML"]
        pass_filenames: false
        stages: [pre-push]

      # FIXER: rimuove C0/C1 e normalizza NFC (se modifica, pre-commit fallirà chiedendo di rieseguire il commit)
      - id: fix-control-chars
        name: Fix Unicode control chars (remove C0/C1 + NFC)
        entry: python scripts/forbid_control_chars.py --fix
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml))$"
        stages: [pre-commit]

      # GUARDIANO: blocca se restano caratteri di controllo o file non-UTF-8
      - id: forbid-control-chars
        name: Forbid Unicode control chars & non-UTF-8
        entry: python scripts/forbid_control_chars.py
        language: system
        pass_filenames: true
        types: [text]
        files: "^(src/.*|tests/.*|docs/.*|.*\\.(md|txt|json|ya?ml))$"
        stages: [pre-commit]

  - repo: https://github.com/zricethezav/gitleaks
    rev: v8.18.1
    hooks:
      - id: gitleaks
        args: [detect, --no-banner, --redact, --config, .gitleaks.toml]
        pass_filenames: false
        stages: [pre-commit]

  - repo: local
    hooks:
      - id: cspell
        name: cspell (docs + README)
        entry: npx --yes -p @cspell/dict-it-it cspell lint --no-progress --config cspell.json
        language: system
        pass_filenames: true
        files: ^(README\.md|docs/.*\.md)$
        stages: [pre-commit]
