name: Secret Scan

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  security-events: write

concurrency:
  group: secret-scan-${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          set -euo pipefail
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.3/gitleaks_8.18.3_linux_x64.tar.gz -o /tmp/gitleaks.tar.gz
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks
          sudo install /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run gitleaks (SARIF)
        run: |
          gitleaks detect --source . --report-format sarif --report-path gitleaks.sarif --no-git

      - name: Upload SARIF
        if: ${{ always() && hashFiles('gitleaks.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@545ea36879f73e6aa087b5f7570ee4f25b4d3a3a # v3.26.7
        with:
          sarif_file: gitleaks.sarif

      - name: Mask Slack webhook
        if: ${{ always() }}
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "::add-mask::${{ secrets.SLACK_WEBHOOK_URL }}"
          fi

      - name: Notify Slack on failure
        if: ${{ failure() && secrets.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_NAME: ${{ github.job }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload=$(python - <<'PY'
            import json, os
            print(json.dumps({
                "text": "[ALERT] GitHub Actions job `{job}` failed in workflow `{wf}`.\nSee details: {url}".format(
                    job=os.environ["JOB_NAME"],
                    wf=os.environ["WORKFLOW"],
                    url=os.environ["RUN_URL"],
                )
            }))
          PY
          )
          curl -sSf -X POST -H 'Content-Type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

