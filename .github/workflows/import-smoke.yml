name: Import Smoke

on:
  pull_request:
    paths:
      - 'src/**'
      - 'requirements*.txt'
      - '.github/workflows/import-smoke.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: import-smoke-${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  import-smoke:
    name: Import modules without side-effects
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with:
          python-version: '3.11'

      - name: Install dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare env and snapshot
        run: |
          echo "FOO_BAR=hello" > .env
          BEFORE_HASH=$(find . -type f \( -not -path "./.git/*" -a -not -path "*/__pycache__/*" -a -not -name "*.pyc" -a -not -path "./out/*" \) -print0 | sort -z | xargs -0 sha256sum | sha256sum)
          echo "$BEFORE_HASH" > before.sha

      - name: Import modules
        run: |
          python - <<'PY'
          import importlib, os, sys
          from pathlib import Path
          ROOT = Path('.').resolve()
          SRC = (ROOT / 'src')
          sys.path.insert(0, str(ROOT))
          sys.path.insert(0, str(SRC))
          modules = [
              'src.pipeline.env_utils',
              'src.semantic.api',
              'src.retriever',
              'src.ingest',
          ]
          for m in modules:
              importlib.import_module(m)
          # ensure .env not consumed at import-time
          assert os.environ.get('FOO_BAR') is None, 'FOO_BAR unexpectedly set at import-time'
          PY

      - name: Check filesystem side-effects
        run: |
          AFTER_HASH=$(find . -type f \( -not -path "./.git/*" -a -not -path "*/__pycache__/*" -a -not -name "*.pyc" -a -not -path "./out/*" \) -print0 | sort -z | xargs -0 sha256sum | sha256sum)
          diff -u before.sha <(echo "$AFTER_HASH") && echo "No file changes after import" || (echo "Detected file changes after import" && exit 1)
      - name: Mask Slack webhook
        if: ${{ always() }}
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "::add-mask::${{ secrets.SLACK_WEBHOOK_URL }}"
          fi
      - name: Notify Slack on failure
        if: ${{ failure() && secrets.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_NAME: ${{ github.job }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload=$(python - <<'PY'
            import json, os
            print(json.dumps({
                "text": "[ALERT] GitHub Actions job `{job}` failed in workflow `{wf}`.\nSee details: {url}".format(
                    job=os.environ["JOB_NAME"],
                    wf=os.environ["WORKFLOW"],
                    url=os.environ["RUN_URL"],
                )
            }))
          PY
          )
          curl -sSf -X POST -H 'Content-Type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
