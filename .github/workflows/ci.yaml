name: CI
on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/ci.yaml'
      - 'mypy.ini'
      - 'pytest.ini'
      - 'qodana.*'
      - 'scripts/ci/**'
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/ci.yaml'
      - 'mypy.ini'
      - 'pytest.ini'
      - 'qodana.*'
      - 'scripts/ci/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2
      - uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with: { python-version: "3.11" }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt
      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.3/gitleaks_8.18.3_linux_x64.tar.gz -o /tmp/gitleaks.tar.gz
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks
          sudo install /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version
      - name: Secrets scan
        run: gitleaks detect --redact --no-git -v
      - name: YAML secrets check
        run: |
          python scripts/dev/check_yaml_secrets.py $(git ls-files 'config/*.yml' 'config/*.yaml')
      - name: Docs UTF-8/accents normalization check
        run: |
          python scripts/fix_mojibake.py
          if ! git diff --quiet; then
            echo "::error::Documentation contains mojibake or non-normalized characters. Run scripts/fix_mojibake.py and commit the changes.";
            git --no-pager diff -- docs README.md | sed -n '1,200p';
            exit 1;
          fi
      - name: Black (check)
        run: black --check src tests
      - name: Ruff (check)
        run: ruff check src tests
      - name: Pytest light regressions
        run: pytest -q -m "regression_light"
      - name: Mypy
        run: mypy src
      - name: Pytest (coverage 85%)
        run: pytest -ra --cov=src --cov-report=xml --cov-fail-under=85
      - name: Upload coverage artifact
        uses: actions/upload-artifact@a8fb1bf1f1b3edc5c079db37d1b5fb4c1b5a52b4 # v4.4.3
        with:
          name: coverage-xml
          path: coverage.xml
      - name: Publish coverage summary
        if: always()
        shell: bash
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          import os
          p = 'coverage.xml'
          try:
              tree = ET.parse(p)
              root = tree.getroot()
              rate = float(root.attrib.get('line-rate', '0')) * 100.0
              summary = f"Coverage: {rate:.2f}% (threshold 85%)\n"
          except Exception as e:
              summary = f"Coverage summary not available: {e}\n"
          out = os.environ.get('GITHUB_STEP_SUMMARY')
          if out:
              with open(out, 'a', encoding='utf-8') as fh:
                  fh.write(summary)
          else:
              print(summary)
          PY

  contract:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2
      - uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with: { python-version: "3.11" }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt
      - name: Pytest contract (nav/gating)
        run: pytest -q -m "contract"

  e2e:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2
      - uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with: { python-version: "3.11" }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt
          pip install playwright pytest-playwright
      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium
      - name: Pytest e2e
        run: pytest -q -m "e2e" --maxfail=1
      - name: Upload e2e artifacts
        if: failure()
        uses: actions/upload-artifact@a8fb1bf1f1b3edc5c079db37d1b5fb4c1b5a52b4 # v4.4.3
        with:
          name: e2e-artifacts
          path: |
            tests/**/*.png
            tests/**/*.webm
            **/clients_db.yaml
            **/clients.yaml
            **/preview_logs/**/*.log
            **/streamlit.log

  push-tests:
    needs: build
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-push-tests')) ||
      startsWith(github.ref, 'refs/heads/push-tests/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2
      - uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with: { python-version: "3.11" }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --requirement requirements-dev.txt
      - name: Pytest push markers
        run: pytest -q -m "push"
