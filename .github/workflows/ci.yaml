name: CI
on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/ci.yaml'
      - 'mypy.ini'
      - 'pytest.ini'
      - 'qodana.*'
      - 'scripts/ci/**'
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/ci.yaml'
      - 'mypy.ini'
      - 'pytest.ini'
      - 'qodana.*'
      - 'scripts/ci/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2
      - uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with: { python-version: "3.11" }
      - name: Install deps
        run: |
          python -m pip install --disable-pip-version-check pip==24.2 wheel==0.44.0
          pip install --disable-pip-version-check \
            black==24.8.0 \
            ruff==0.6.4 \
            mypy==1.11.2 \
            pytest==8.3.2 \
            pytest-cov==5.0.0
      - name: Docs UTF-8/accents normalization check
        run: |
          python scripts/fix_mojibake.py
          if ! git diff --quiet; then
            echo "::error::Documentation contains mojibake or non-normalized characters. Run scripts/fix_mojibake.py and commit the changes.";
            git --no-pager diff -- docs README.md | sed -n '1,200p';
            exit 1;
          fi
      - name: Black (check)
        run: black --check src tests
      - name: Ruff (check)
        run: ruff check src tests
      - name: Mypy
        run: mypy src
      - name: Pytest (coverage 85%)
        run: pytest -ra --cov=src --cov-report=xml --cov-fail-under=85
      - name: Upload coverage artifact
        uses: actions/upload-artifact@a8fb1bf1f1b3edc5c079db37d1b5fb4c1b5a52b4 # v4.4.3
        with:
          name: coverage-xml
          path: coverage.xml
      - name: Publish coverage summary
        if: always()
        shell: bash
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          import os
          p = 'coverage.xml'
          try:
              tree = ET.parse(p)
              root = tree.getroot()
              rate = float(root.attrib.get('line-rate', '0')) * 100.0
              summary = f"Coverage: {rate:.2f}% (threshold 85%)\n"
          except Exception as e:
              summary = f"Coverage summary not available: {e}\n"
          out = os.environ.get('GITHUB_STEP_SUMMARY')
          if out:
              with open(out, 'a', encoding='utf-8') as fh:
                  fh.write(summary)
          else:
              print(summary)
          PY
