name: CI
on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with: { python-version: "3.11" }
      - name: Install deps
        run: |
          python -m pip install -U pip wheel
          pip install black flake8 flake8-bugbear flake8-annotations flake8-bandit flake8-print mypy pytest pytest-cov
      - name: Docs UTF-8/accents normalization check
        run: |
          python tools/fix_mojibake.py
          if ! git diff --quiet; then
            echo "::error::Documentation contains mojibake or non-normalized characters. Run tools/fix_mojibake.py and commit the changes.";
            git --no-pager diff -- docs README.md | sed -n '1,200p';
            exit 1;
          fi
      - name: Black (check)
        run: black --check src tests
      - name: Flake8
        run: flake8 src tests
      - name: Mypy
        run: mypy src
      - name: Pytest (coverage 85%)
        run: pytest -ra --cov=src --cov-report=xml --cov-fail-under=85
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
      - name: Publish coverage summary
        if: always()
        shell: bash
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          import os
          p = 'coverage.xml'
          try:
              tree = ET.parse(p)
              root = tree.getroot()
              rate = float(root.attrib.get('line-rate', '0')) * 100.0
              summary = f"Coverage: {rate:.2f}% (threshold 85%)\n"
          except Exception as e:
              summary = f"Coverage summary not available: {e}\n"
          out = os.environ.get('GITHUB_STEP_SUMMARY')
          if out:
              with open(out, 'a', encoding='utf-8') as fh:
                  fh.write(summary)
          else:
              print(summary)
          PY

  sca:
    name: Security Audit (pip-audit)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with: { python-version: "3.11" }
      - name: Install pip-audit
        run: |
          python -m pip install -U pip
          pip install pip-audit
      - name: Run pip-audit and gate on critical vulns
        shell: bash
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail
          rm -f pip-audit.json || true
          if [ -f "requirements.txt" ]; then
            echo "Running pip-audit on requirements.txt"
            pip-audit -r requirements.txt -f json -o pip-audit.json || true
          elif [ -f "pyproject.toml" ]; then
            echo "Installing project (editable) and auditing installed env"
            pip install -e . || true
            pip-audit -f json -o pip-audit.json || true
          else
            echo "No manifest found (requirements.txt/pyproject.toml); auditing current env"
            pip-audit -f json -o pip-audit.json || true
          fi
          if [ ! -s pip-audit.json ]; then
            echo "{}" > pip-audit.json
          fi
          CRIT=$(jq -r '[.dependencies[]? | .vulns[]? | select(.severity=="critical")] | length' pip-audit.json || echo 0)
          echo "Critical vulnerabilities found: $CRIT"
          if [ "$CRIT" != "0" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "::error::pip-audit found $CRIT critical vulnerability(ies)"
            exit 1
          fi
