name: Bench Embeddings Normalization

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: read

concurrency:
  group: bench-${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bench:
    name: Run bench script (non-gating)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2

      - name: Setup Python
        uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with:
          python-version: '3.11'

      - name: Install dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run bench (JSON output)
        run: |
          python -m scripts.bench_embeddings_normalization --json out/bench.json --baseline scripts/bench_baseline.json || true

      - name: Upload artifact
        uses: actions/upload-artifact@a8fb1bf1f1b3edc5c079db37d1b5fb4c1b5a52b4 # v4.4.3
        with:
          name: bench-results
          path: out/bench.json
          if-no-files-found: warn

      - name: Append summary
        run: |
          echo "# Bench Embeddings Normalization" >> $GITHUB_STEP_SUMMARY
          if [ -f out/bench.json ]; then
            python - <<'PY'
            import json
            from pathlib import Path
            data = json.loads(Path('out/bench.json').read_text(encoding='utf-8'))
            def section_nested(title, d, delta=None):
                print(f"\n## {title}")
                for sz, items in (d or {}).items():
                    print(f"\n### Size {sz}")
                    if delta and sz in delta:
                        print("\n| case | seconds | delta% |\n|---|---:|---:|")
                        for k, v in items.items():
                            dv = delta.get(sz, {}).get(k)
                            dvs = f"{dv:+.2f}%" if isinstance(dv, (int,float)) else "-"
                            print(f"| {k} | {v:.6f} | {dvs} |")
                    else:
                        print("\n| case | seconds |\n|---|---:|")
                        for k, v in items.items():
                            print(f"| {k} | {v:.6f} |")
            print()
            dlt = (data.get('delta_pct') or {}) if isinstance(data, dict) else {}
            if isinstance(data, dict) and 'retriever' in data:
                section_nested('Retriever', data['retriever'], dlt.get('retriever'))
            if isinstance(data, dict) and 'semantic_index_markdown_to_db' in data:
                section_nested('Semantic Index', data['semantic_index_markdown_to_db'], dlt.get('semantic_index_markdown_to_db'))
            PY
          else
            echo "No JSON produced." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Artifacts soft check
        run: |
          python - <<'PY'
          import json, sys
          from pathlib import Path
          p = Path('out/bench.json')
          if not p.exists():
              sys.exit(0)
          data = json.loads(p.read_text(encoding='utf-8'))
          arts = (data.get('semantic_index_artifacts') or {})
          warn = []
          for sz, items in arts.items():
              for k, v in items.items():
                  try:
                      iv = int(v)
                  except Exception:
                      continue
                  if iv == 0:
                      warn.append(f"WARNING: artifacts=0 for semantic[{sz}].{k}")
          if warn:
              print("\n".join(warn))
          PY
