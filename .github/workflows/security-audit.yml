name: Security Audit (pip-audit)

on:
  pull_request:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 4 * * 1" # ogni lunedÃ¬ 04:00 UTC
  workflow_dispatch:

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032f49b8222c4a59f611bc62 # v4.2.2
      - uses: actions/setup-python@13b84548a520c9f0b36e3cd122184fb4b3f6e9c5 # v5.1.0
        with: { python-version: "3.11" }
      - name: Install pip-audit
        run: |
          python -m pip install --require-hashes \
            pip==24.2 --hash=sha256:2cd581cf58ab7fcfca4ce8efa6dcacd0de5bf8d0a3eb9ec927e07405f4d9e2a2
          pip install --require-hashes \
            pip-audit==2.7.2 --hash=sha256:49907430115baacb8bb7ffc1a2b689acfeac9d8534a43bffad3c73f8d8b32d52
      - name: Run pip-audit (soft gate on PR, hard on main/schedule)
        shell: bash
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail
          rm -f pip-audit.json || true
          if [ -f "requirements.txt" ]; then
            echo "Running pip-audit on requirements.txt"
            pip-audit -r requirements.txt -f json -o pip-audit.json || true
          elif [ -f "pyproject.toml" ]; then
            echo "Installing project (editable) and auditing installed env"
            pip install -e . || true
            pip-audit -f json -o pip-audit.json || true
          else
            echo "No manifest found (requirements.txt/pyproject.toml); auditing current env"
            pip-audit -f json -o pip-audit.json || true
          fi
          if [ ! -s pip-audit.json ]; then
            echo "{}" > pip-audit.json
          fi
          CRIT=$(jq -r '[.dependencies[]? | .vulns[]? | select(.severity=="critical")] | length' pip-audit.json || echo 0)
          echo "Critical vulnerabilities found: $CRIT"
          if [ "$CRIT" != "0" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "::error::pip-audit found $CRIT critical vulnerability(ies)"
            exit 1
          fi
