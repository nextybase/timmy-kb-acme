name: Security Audit (pip-audit)

on:
  pull_request:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 4 * * 1" # ogni lunedÃ¬ 04:00 UTC
  workflow_dispatch:

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install pip-audit
        run: |
          python -m pip install -U pip
          pip install pip-audit
      - name: Run pip-audit (soft gate on PR, hard on main/schedule)
        shell: bash
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail
          rm -f pip-audit.json || true
          if [ -f "requirements.txt" ]; then
            echo "Running pip-audit on requirements.txt"
            pip-audit -r requirements.txt -f json -o pip-audit.json || true
          elif [ -f "pyproject.toml" ]; then
            echo "Installing project (editable) and auditing installed env"
            pip install -e . || true
            pip-audit -f json -o pip-audit.json || true
          else
            echo "No manifest found (requirements.txt/pyproject.toml); auditing current env"
            pip-audit -f json -o pip-audit.json || true
          fi
          if [ ! -s pip-audit.json ]; then
            echo "{}" > pip-audit.json
          fi
          CRIT=$(jq -r '[.dependencies[]? | .vulns[]? | select(.severity=="critical")] | length' pip-audit.json || echo 0)
          echo "Critical vulnerabilities found: $CRIT"
          if [ "$CRIT" != "0" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "::error::pip-audit found $CRIT critical vulnerability(ies)"
            exit 1
          fi
