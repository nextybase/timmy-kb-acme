name: Security Audit (pip-audit)

on:
  pull_request:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 4 * * 1" # ogni lunedÃ¬ 04:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: security-audit-${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - uses: actions/setup-python@v5 # v5
        with: { python-version: "3.11" }
      - name: Install pip-audit
        run: |
          python -m pip install --require-hashes \
            pip==24.2 --hash=sha256:2cd581cf58ab7fcfca4ce8efa6dcacd0de5bf8d0a3eb9ec927e07405f4d9e2a2
          pip install --require-hashes \
            pip-audit==2.7.2 --hash=sha256:49907430115baacb8bb7ffc1a2b689acfeac9d8534a43bffad3c73f8d8b32d52
      - name: Run pip-audit (soft gate on PR, hard on main/schedule)
        shell: bash
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail
          rm -f pip-audit.json || true
          if [ -f "requirements.txt" ]; then
            echo "Running pip-audit on requirements.txt"
            pip-audit -r requirements.txt -f json -o pip-audit.json || true
          elif [ -f "pyproject.toml" ]; then
            echo "Installing project (editable) and auditing installed env"
            pip install -e . || true
            pip-audit -f json -o pip-audit.json || true
          else
            echo "No manifest found (requirements.txt/pyproject.toml); auditing current env"
            pip-audit -f json -o pip-audit.json || true
          fi
          if [ ! -s pip-audit.json ]; then
            echo "{}" > pip-audit.json
          fi
          CRIT=$(jq -r '[.dependencies[]? | .vulns[]? | select(.severity=="critical")] | length' pip-audit.json || echo 0)
          echo "Critical vulnerabilities found: $CRIT"
          if [ "$CRIT" != "0" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "::error::pip-audit found $CRIT critical vulnerability(ies)"
            exit 1
          fi
      - name: Mask Slack webhook
        if: ${{ always() }}
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "::add-mask::${{ secrets.SLACK_WEBHOOK_URL }}"
          fi
      - name: Notify Slack on failure
        if: ${{ failure() && secrets.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_NAME: ${{ github.job }}
          WORKFLOW: ${{ github.workflow }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          payload=$(python - <<'PY'
            import json, os
            print(json.dumps({
                "text": "[ALERT] GitHub Actions job `{job}` failed in workflow `{wf}`.\nSee details: {url}".format(
                    job=os.environ["JOB_NAME"],
                    wf=os.environ["WORKFLOW"],
                    url=os.environ["RUN_URL"],
                )
            }))
          PY
          )
          curl -sSf -X POST -H 'Content-Type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
