## [Unreleased]  2025-11-13
<!-- cspell:ignore configurativo -->
- Hardening sicurezza: lettura di `tags_raw.json` in `kg_builder` ora usa `read_text_safe` con path validato (niente `Path.read_text` diretto) per rispettare i vincoli path-safety.
- Migrazione namespace: rimosso il pacchetto/alias legacy `timmykb.*`; tutti gli import usano ora i moduli locali (`ingest`, `pipeline.*`, `semantic.*`, `ui.*`). Preflight aggiornato per segnalare solo la coerenza dei moduli pipeline.
- Logging/osservabilita: logger UI centralizzato (`.timmykb/logs/ui.log` con propagazione), redazione estesa (token/secret/password/key/service_account) e Promtail che etichetta anche `run_id`/`trace_id`/`span_id` per i log UI; gli entrypoint CLI (`pre_onboarding`, `tag_onboarding`, `onboarding_full`) aprono ora trace root OTEL per la correlazione Grafana/Tempo; `log_viewer` mostra anche righe non strutturate.
- BREAKING (Vision): `semantic.vision_provision.provision_from_vision` richiede ora sempre `model` esplicito (UI/CLI passano `get_vision_model()`); rimosso il fallback implicito e il flag `force` verso il layer semantic. Aggiornare eventuali caller custom/tool esterni.
- Unity of the semantic test suite: `build_vocab_db` now covers merge-into aliases, duplicates, canonical-only, plus new DB-first guards (load failure, duplicate alias, merge_into semantics) so every matcher test runs on the real `tags.db`.
- Vision provisioning riallineato allo health-check: `use_kb` segue ENV/Settings/config (default True) e le `run_instructions` abilitano File Search solo quando il flag e attivo.
- `vision_alignment_check.py` now reads `vision.use_kb`/`vision.strict_output` from `Settings`, logs the chosen source, and applies the configured OpenAI timeout/retries/http2 so the tool mirrors the UI SSoT.
- `vision_alignment_check.py` builds the JSON Schema only when `vision.strict_output` is `true`, otherwise it omits the `text` payload so the check stays as permissive as the UI uptime.
- `vision_alignment_check.py` registra `vision_alignment_check.strict_output` con `value`/`source` e include `strict_output` + `response_format` nell'output JSON; i nuovi `tests/scripts/test_vision_alignment_check.py` coprono i casi config vs default.
- Il payload Vision ora aggiunge `assistant_id` e `assistant_id_source` (log `vision_alignment_check.assistant_id`), migliorando la tracciabilita dei fallimenti dell'assistente.
- Il JSON e i log del tool Vision riportano ora anche `assistant_env`/`assistant_env_source`, e un nuovo test CLI (`test_assistant_missing_reports_missing`) garantisce che lo scenario senza assistant resti visibile come missing.
- `build_vocab_db` ora rispetta la numerazione `pos` corrente in `tag_synonyms` (usa `MAX(pos)+1` come base) e mantiene l'ordine first-hit anche quando la fixture viene rilanciata con alias duplicati o merge successivi.
- _Semantic pipeline_ ora conserva l'ordine first-hit degli alias in `semantic.vocab_loader` e la suite `tests/test_semantic_extractor.py` gira realmente su `semantic/tags.db` grazie alla fixture `build_vocab_db`, coprendo la traccia DB-first anche per `canonicalOnly`.
- _Vision check_ (`scripts/vision_alignment_check.py`) legge `config/config.yaml` (`ai.vision.model`, `ai.vision.assistant_id_env`, `ai.openai.timeout/max_retries/http2`) e passa i parametri al client: il health-check segue lo stesso SSoT configurativo dellUI.
- Documentazione e test rimangono allineati: `docs/streamlit_ui.md` descrive il gating condiviso e i test `tests/ui/test_semantics_state.py` restano il riferimento per il messaggio di gating.
- Gating Semantica e Drive logging sono stati rinforzati per strumenti da runbook: `_require_semantic_gating` ricalcola `has_raw_pdfs` anche quando riusa lo stato cache, svuota la cache se i PDF scompaiono e solleva `RuntimeError`, `tests/ui/test_semantics_state.py` coprono la rivisitazione e il nuovo path raw, mentre `src/ui/pages/manage.py`/`src/ui/manage/drive.py` registrano `ui.manage.drive.*` (diff/readme/piano/download) e validano `SERVICE_ACCOUNT_FILE` prima di abilitare il download con un test dedicato (`tests/ui/test_manage_drive.py`).
- QA: suite completa `python -m pytest -q` verde su Windows (10 skipped per symlink non supportati); pre-commit pulito dopo normalizzazione Markdown.
